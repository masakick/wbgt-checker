# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際のClaude Code (claude.ai/code)へのガイダンスを提供します。

## プロジェクト概要

日本全国840地点の気温とWBGT（暑さ指数）値をリアルタイムで表示する熱中症予防情報Webアプリケーションです。

## 主要なアーキテクチャ

### データフロー
1. **データソース**: 
   - 気温データ：気象庁（JMA）APIから`php/fetchTemp.php`経由で取得
   - WBGT データ：環境省熱中症予防情報サイトから取得
   - データは毎時40分頃に更新

2. **フロントエンドアーキテクチャ**:
   - 各地点ごとの静的HTMLページ（`dist/wbgt/[地点コード].html`）
   - p5.jsライブラリを使用した動的なビジュアライゼーション
   - ビルドプロセスなし - バニラJavaScriptを直接読み込み
   - PWA対応のモバイルレスポンシブデザイン

3. **バックエンド**:
   - データ取得用の最小限のPHPスクリプト
   - ファイルベースのデータストレージ（CSV/JSON形式）
   - データベース不要

## 開発コマンド

ビルドツールを使用しない静的サイトプロジェクトです。開発方法：

1. **ローカル開発**: HTMLファイルを直接ブラウザで開くか、ローカルWebサーバーを使用
2. **テスト**: 手動テストのみ - テストスイートは未設定
3. **デプロイ**: `dist/`ディレクトリの内容をWebサーバーにアップロード

## 重要な実装詳細

### 暑さ指数警戒レベル
5段階の色分け警戒レベルを使用：
- レベル1（青）：安全
- レベル2（緑）：注意
- レベル3（黄）：警戒
- レベル4（橙）：厳重警戒
- レベル5（赤）：危険

### 主要ファイル
- `dist/index.js`: 地域選択ロジックとナビゲーション
- `dist/sketch.js`: 暑さ指数表示用のp5.jsビジュアライゼーション
- `dist/php/fetchTemp.php`: JMAから気温データを取得
- `dist/php/exportcsv.php`: CSV出力機能

### データ形式
- 地点コードはJMAの地域コードシステムに準拠
- 各地点ページは気温、WBGT値、予報データを含む特定のJSON形式を想定

## リニューアル計画

### 現在の課題
1. **840個のHTMLファイル管理が煩雑**
2. **デザインが古い**
3. **モバイル対応が不十分**

### 新しいアーキテクチャ（Next.js 14）
- **フレームワーク**: Next.js 14 (App Router) + TypeScript
- **スタイリング**: Tailwind CSS
- **レンダリング**: Static Site Generation (SSG) + ISR
- **ルーティング**: Dynamic Routes (`/wbgt/[locationCode]`)
- **PWA**: シンプルなmanifest.jsonでホーム画面追加対応

### バックエンド設計（承認済み）

#### データ更新フロー
1. **環境省CSV URL自動生成**
   - 現在: `wbgt_all_202506.csv` (毎月1日0時に手動変更)
   - 新システム: JavaScript Date オブジェクトで自動生成
   - 月末・月初の移行期間は前月・当月両方をトライしてフォールバック

2. **スケジュール実行（Vercel Cron Jobs）**
   - **毎時20分**: `api/cron/fetch-temperature` - 気温データ更新
   - **毎時40分**: `api/cron/fetch-wbgt` - WBGT データ更新

3. **データストレージ**
   - Vercel File System (一時ストレージ)
   - `public/data/temperature.json` - 気温データ
   - `public/data/wbgt.json` - WBGT データ
   - ISR により静的ファイル生成時に最新データを使用

4. **エラーハンドリング**
   - リトライロジック（3回まで）
   - ログ出力機能
   - フォールバック戦略（前回の成功データを使用）

## ✅ 開発完了状況（2025年6月21日）

### 🎯 実装完了フェーズ
- ✅ **Phase 1**: データ取得インフラ（URL生成、HTTPクライアント）
- ✅ **Phase 2**: Cron API実装（/api/cron/fetch-*）
- ✅ **Phase 3**: フロントエンド統合（ISR設定、データ表示）
- ✅ **Phase 4**: PWA対応（manifest.json、サービスワーカー）
- ✅ **Phase 5**: テスト・監視（エラーログ、パフォーマンス）
- ✅ **Phase 6**: UIユーザビリティ改善（ユーザーフィードバック対応）
- ✅ **Phase 7**: 最終バグ修正（沖縄地方表示・WBGT単位統一）

### 🌍 840地点完全対応
- ✅ **全国840地点データベース**: `src/lib/complete-locations.ts`で完全実装
- ✅ **動的ルーティング**: `/wbgt/[locationCode]`で全地点対応
- ✅ **ISR + 動的生成**: 主要47地点事前生成 + 793地点動的生成
- ✅ **モックデータ自動生成**: 地域別気候特性を考慮した自動データ生成
- ✅ **検索機能**: 840地点での部分一致検索（最大50件表示）

### 🛠️ 実装済み機能

#### コアシステム
- ✅ **Next.js 14 App Router + TypeScript**: モダンな開発環境
- ✅ **Tailwind CSS**: レスポンシブデザインシステム
- ✅ **動的メタデータ生成**: SEO対応
- ✅ **PWA対応**: ホーム画面追加、サービスワーカー、インストールプロンプト

#### データ管理
- ✅ **Vercel Cron Jobs**: 毎時20分（気温）・40分（WBGT）自動更新
- ✅ **URL自動生成**: 月次CSVファイル変更に自動対応
- ✅ **リトライロジック**: 3回まで再試行、指数バックオフ
- ✅ **フォールバック機能**: 前月データでの代替取得

#### UIコンポーネント
- ✅ **WBGTVisualization**: p5.js代替の大型ビジュアライゼーション
- ✅ **DetailedForecastTable**: 21時点×3日間の詳細予報表示
- ✅ **ActivityGuideSelector**: 5段階運動指針 + 8活動場所ガイド
- ✅ **ShareAndSaveButtons**: Twitter/LINE共有、画像保存機能
- ✅ **QRCodeSection**: 動的QRコード生成・表示
- ✅ **PWAInstaller**: インストールプロンプト表示

#### ページ構成
- ✅ **トップページ**: 地点選択、地方別ナビゲーション
- ✅ **地点詳細ページ**: 840地点すべて対応
- ✅ **モックアップページ**: 開発・デザイン確認用

### 📁 主要ファイル構成

#### データ管理層
- `src/lib/complete-locations.ts` - 840地点完全データベース
- `src/lib/data-fetcher.ts` - データ取得・モック生成
- `src/lib/data-processor.ts` - データ変換・レベル判定
- `src/lib/data-urls.ts` - URL生成・データ取得
- `src/lib/http-client.ts` - リトライ機能付きHTTPクライアント

#### API層
- `src/app/api/cron/fetch-wbgt/route.ts` - WBGT データ取得API
- `src/app/api/cron/fetch-temperature/route.ts` - 気温データ取得API
- `vercel.json` - Cron Jobs設定

#### フロントエンド層
- `src/app/page.tsx` - トップページ（地点選択）
- `src/app/wbgt/[locationCode]/page.tsx` - 動的地点詳細ページ
- `src/components/` - 各種UIコンポーネント

#### PWA対応
- `public/manifest.json` - PWAマニフェスト
- `public/sw.js` - サービスワーカー
- `src/components/PWAInstaller.tsx` - インストールプロンプト

### 🎨 デザインシステム
- **5段階警戒レベル**: 青（安全）→緑（注意）→黄（警戒）→橙（厳重警戒）→赤（危険）
- **モバイルファースト**: スマートフォン最適化
- **グラデーション背景**: 温度・湿度に応じた視覚的表現
- **アニメーション**: CSS transitionによるスムーズな状態変化

### 技術スタック移行
- ✅ **旧**: バニラJS + p5.js + PHP → **新**: Next.js + TypeScript + Tailwind CSS
- ✅ **可視化**: p5.js → CSS/SVGアニメーション
- ✅ **データ**: 静的HTML × 840 → 動的ルーティング
- ✅ **更新**: 手動月次変更 → 自動URL生成

## 📋 完了したタスク

### ✅ 実装完了（2025年6月20日）
1. **フロントエンドUIの動作確認とデバッグ**
   - ✅ モバイルデバイスでの表示確認
   - ✅ 各コンポーネントの動作テスト
   - ✅ レスポンシブデザインの調整

2. **データ精度向上**
   - ✅ 実際の環境省APIエンドポイント調査・統合
   - ✅ 気象庁APIの詳細仕様確認
   - ✅ 実データでのテスト・調整（836/840地点）

3. **パフォーマンス最適化**
   - ✅ 画像最適化（アイコン、スクリーンショット生成）
   - ✅ バンドルサイズ最適化（101 KB共有JS）
   - ✅ Core Web Vitals計測・改善

4. **機能拡張**
   - ✅ 地点お気に入り機能（ローカルストレージ）
   - ✅ エラー監視システム（Sentry統合）
   - ✅ アクセス解析（Vercel Analytics統合）

5. **SEO・マーケティング**
   - ✅ サイトマップ生成（840地点）
   - ✅ OGP画像動的生成（/api/og）
   - ✅ 構造化データ追加（JSON-LD）

### 🔮 将来の拡張予定
- [ ] 通知機能（警戒レベル変更時）
- [ ] アクセシビリティ向上（スクリーンリーダー対応）
- [ ] 気象庁AMeDAS APIとの完全統合
- [ ] 多言語対応（英語、中国語、韓国語）

### ✅ ユーザーフィードバック対応（11項目完了）
1. **検索機能の実装**: オートコンプリート対応、840地点検索
2. **地方選択の修正**: 正しい11地方でのドリルダウン選択  
3. **自動スクロール機能**: 地方→都道府県→地点への段階的スクロール
4. **お気に入り配置調整**: 検索より上に移動、マージン追加
5. **ボタン動作修正**: WBGTカードの「地点選択」「データ再読込み」ボタン実装
6. **詳細ページ調整**: 戻るボタン削除、WBGT値の℃表記削除
7. **Aboutページ追加**: 利用規約とサイト情報ページ作成
8. **ヘッダーメニュー追加**: ハンバーガーメニューで5項目表示
9. **ロゴ追加**: レスポンシブ対応のサイトロゴ実装
10. **沖縄地方表示修正**: 特殊なID対応で那覇など16地点表示
11. **WBGT単位統一**: 詳細ページでWBGT値の℃表記削除

### ⚠️ 既知の制限事項
- 4地点（74181等）のデータが環境省APIに存在しない（モックデータで代替）
- 一部地点の地名表記要確認（JMA公式名称との照合）

## 🚀 デプロイ準備（次のステップ）

### 1. 環境変数設定
`.env.local`ファイルに以下を設定：
```bash
# 必須
CRON_SECRET=ランダムな文字列を生成して設定
NEXT_PUBLIC_SITE_URL=https://your-domain.com

# オプション（エラー監視）
SENTRY_DSN=Sentryプロジェクトから取得
NEXT_PUBLIC_SENTRY_DSN=同上
SENTRY_ORG=Sentry組織名
SENTRY_PROJECT=Sentryプロジェクト名
SENTRY_AUTH_TOKEN=Sentry認証トークン

# オプション（アクセス解析）
NEXT_PUBLIC_GA_MEASUREMENT_ID=Google Analytics ID
```

### 2. Vercelデプロイ手順
1. Vercelアカウントでプロジェクト作成
2. GitHubリポジトリと連携
3. 環境変数を設定
4. デプロイ実行

### 3. デプロイ後の確認事項
- [ ] Cron Jobsが正常に動作（毎時20分・40分）
- [ ] PWAインストール機能
- [ ] 840地点すべてのページアクセス
- [ ] OGP画像の生成確認
- [ ] サイトマップの確認（/sitemap.xml）

### 4. 運用開始後のタスク
- [ ] 実データでの動作確認（1週間程度）
- [ ] パフォーマンスモニタリング
- [ ] エラー監視（Sentry）
- [ ] アクセス解析（Vercel Analytics）
- [ ] 残り4地点のデータ対応検討

## ✅ UI/UX改善完了（2025年6月22日）

### 🎯 完了した改善項目
以下の3つのタスクがすべて完了しました：

#### Task 1: お気に入りエリアの表示内容改善 ✅
- リアルタイムWBGT値・警戒レベル・更新時刻を表示
- 警戒レベルの隣に運動指針（ガイドライン）を追加
- 時刻表示を日本語形式に変更（6月22日 10時30分）
- レイアウト改善（時刻を上部に配置）
- 無限レンダリング問題を解決、開発環境でのAPI負荷軽減

#### Task 2: 主要地点エリアの表示内容改善 ✅
- 主要6地点（札幌、仙台、東京、名古屋、大阪、福岡）に絞り込み
- お気に入りエリアと同様のデザイン統一
- リアルタイムWBGT値と警戒レベルの色分け表示
- パフォーマンス最適化済み

#### Task 3: 詳細ページ - お気に入りボタンの配置・機能改善 ✅
- ボタンを画面右上に固定配置（スクロール対応）
- お気に入り登録・削除時のリアクション機能を実装：
  - トースト通知（成功・情報メッセージ）
  - ハートボタンアニメーション（バウンス・震え効果）
  - 3秒自動消去、手動クローズ対応
- 全ページの時刻表示統一（共通formatJapaneseTime関数）

### 🛠️ 実装済み技術要素
- **トースト通知システム**: React Context API + カスタムアニメーション
- **時刻フォーマット統一**: 全コンポーネントで日本語形式適用
- **レスポンシブデザイン**: モバイル・デスクトップ最適化
- **パフォーマンス**: 開発環境モックデータ、無限レンダリング対策

## ✅ PWAインストール機能修正完了（2025年6月23日）

### 🎯 完了した修正項目
以下のPWA関連の修正がすべて完了しました：

#### 修正内容
- ✅ Service Worker登録をlayout.tsxに実装
- ✅ PWAInstallerコンポーネントの改善（重複登録削除、デバッグログ追加）
- ✅ manifest.jsonのアイコン最適化（192x192と512x512のみに絞り込み）
- ✅ Chrome/Edge/SafariすべてでPWAインストール機能が動作確認済み
- ✅ PWAアイコン変更ガイドのドキュメント作成（/docs/PWA_ICON_GUIDE.md）

## 🚀 デプロイ準備TODO

### 1. 技術的準備
- [ ] **環境変数設定の確認**
  - CRON_SECRET（必須）
  - NEXT_PUBLIC_SITE_URL（必須）
  - Sentry設定（オプション）
  - Google Analytics設定（オプション）

- [ ] **最終動作テスト**
  - 全841地点ページアクセス確認
  - リダイレクト機能の確認
    - 廃止地点41171→トップページ
    - 変更地点（45147、74181、88836）→新コード
  - お気に入り機能（追加・削除・トースト通知）
  - 検索機能・地方別選択機能
  - PWAインストール機能（Chrome/Edge/Safari）
  - モバイル・デスクトップ表示確認

- [ ] **パフォーマンス最終チェック**
  - Lighthouse スコア確認
  - Core Web Vitals 測定
  - バンドルサイズ確認
  - 画像最適化確認

### 2. Vercelデプロイ実行
- [ ] **Vercelプロジェクト設定**
  - GitHubリポジトリとの連携
  - 環境変数の設定
  - ドメイン設定（必要に応じて）

- [ ] **デプロイ実行**
  - 本番ビルド確認
  - 初回デプロイ実行
  - DNS設定（独自ドメイン使用時）

### 3. 本番環境確認
- [ ] **Cron Jobs動作確認**
  - 毎時20分：気温データ更新確認
  - 毎時40分：WBGTデータ更新確認
  - エラーログの監視

- [ ] **全機能動作確認**
  - 実データでの表示確認
  - 841地点すべてのページ確認
  - API応答速度確認
  - OGP画像生成確認

### 4. 運用開始・監視
- [ ] **監視体制構築**
  - Vercel Analytics設定確認
  - Sentry エラー監視開始
  - パフォーマンス監視設定

- [ ] **運用確認期間**
  - 1週間の実データ動作確認
  - ユーザーフィードバック収集
  - パフォーマンス指標監視

### 5. 将来改善検討
- [x] **残課題対応**
  - ~~4地点のデータ未対応問題~~ → 解決済み（リダイレクト実装）
  - 地名表記の最終確認
  - 多言語対応検討

- [ ] **機能拡張**
  - 通知機能（警戒レベル変更時）
  - アクセシビリティ向上
  - 気象庁AMeDAS APIとの完全統合

## 📋 開発履歴アーカイブ

### 旧予定項目（完了済み）

#### 1. トップページ - お気に入りエリアの表示内容
**現状**: シンプルなリスト表示
**検討事項**:
- お気に入り地点が未登録時の表示（説明文・推奨地点提案など）
- 登録済み地点の表示形式（カード形式 vs リスト形式）
- 各地点の追加情報表示（現在のWBGT値・警戒レベル・更新時刻など）
- 地点削除機能の配置・操作方法
- 表示順序の設定（登録順 vs 警戒レベル順 vs 地名順）

#### 2. 主要地点エリアの表示内容
**現状**: 地点名・都道府県・地方のみ表示
**検討事項**:
- リアルタイムWBGT値の表示
- 警戒レベルの色分け表示
- 最終更新時刻の表示
- 地点選択前のプレビュー機能
- カードデザインの改善（グラデーション・アニメーション）

#### 3. 詳細ページ - お気に入りボタンの配置位置
**現状**: メインビジュアライゼーション右上
**検討事項**:
- ヘッダーエリアへの移動
- WBGTカード内の最適な配置
- ボタンサイズ・デザインの改善
- ハート形状 vs 星形状 vs その他アイコン
- お気に入り登録時のフィードバック（アニメーション・メッセージ）
- モバイル表示での最適化

### 🛠️ 技術的検討事項
- **パフォーマンス**: お気に入り地点のリアルタイムデータ取得方法
- **キャッシュ戦略**: 頻繁にアクセスされる地点のデータキャッシュ
- **アニメーション**: スムーズなUI遷移とユーザーフィードバック

## 開発時の注意事項

- 地点ページを修正する際は、840の全地点HTMLファイルの一貫性を保つこと
- 緊急情報配信のためパフォーマンスとアクセシビリティを最優先
- 多くのユーザーがスマートフォンでアクセスするためモバイル最適化は必須
- 熱中症の緊急時に素早く情報にアクセスできるシンプルで明確なUIを維持